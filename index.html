<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TEST Alliance â€“ Deployment Tracker</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{
    --bg:#0a0a0a;          /* deep black */
    --fg:#eef1ff;          /* text */
    --muted:rgba(220,230,255,.78);
    --panel:rgba(255,255,255,.05);   /* static glass */
    --stroke:rgba(255,255,255,.12);
    --accent:#a0b4ff; --accent2:#6ad8ff;
    --wrap:1100px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,sans-serif;
    background:#000; /* pure black behind stars */
  }

  /* STARFIELD â€” slow drift, white stars, very gentle twinkle */
  .stars{position:fixed;inset:0;z-index:0;pointer-events:none}
  .stars:before,.stars:after{
    content:"";position:absolute;inset:0;opacity:.22;
    background:
      radial-gradient(circle at 15% 25%, rgba(255,255,255,.8) 0 1px, transparent 2px) 0 0/140px 140px,
      radial-gradient(circle at 75% 65%, rgba(255,255,255,.7) 0 1px, transparent 2px) 0 0/180px 180px,
      radial-gradient(circle at 55% 15%, rgba(255,255,255,.6) 0 1px, transparent 2px) 0 0/220px 220px;
    animation: drift1 120s linear infinite, twinkle 20s ease-in-out infinite;
  }
  .stars:after{
    opacity:.16;filter:blur(.25px);
    transform:translateZ(0); /* smooth */
    animation: drift2 180s linear infinite, twinkle 26s ease-in-out infinite;
  }
  @keyframes drift1{ 0%{background-position:0 0,0 0,0 0} 100%{background-position:-200px -120px, -180px -90px, -140px -60px} }
  @keyframes drift2{ 0%{background-position:0 0,0 0,0 0} 100%{background-position:-260px -140px, -220px -100px, -180px -70px} }
  @keyframes twinkle{0%,100%{opacity:.16}50%{opacity:.26}}

  /* CONTENT above stars */
  header, main { position:relative; z-index:1; }

  header{
    position:sticky;top:0;z-index:10;
    background:rgba(10,10,10,.7);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--stroke);
  }
  .wrap{max-width:var(--wrap);margin:0 auto;padding:.75rem 1rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto}
  .muted{color:var(--muted)}
  .chip{
    display:inline-flex;align-items:center;gap:.35rem;
    padding:.18rem .6rem;border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    font-size:.85rem
  }
  button{
    font:inherit;padding:.5rem .85rem;border-radius:.65rem;cursor:pointer;
    border:1px solid rgba(255,255,255,.18);
    background:#151515;color:var(--fg)
  }

  main{padding:1rem 0 3rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem}

  /* CARDS â€” static glass, NO color sweep */
  .card{
    border:1px solid var(--stroke);border-radius:16px;padding:1rem;
    background:var(--panel);
    box-shadow:0 12px 36px rgba(0,0,0,.35);
  }

  .bar{height:10px;border-radius:999px;background:rgba(255,255,255,.07);
    border:1px solid rgba(255,255,255,.16);overflow:hidden}
  .bar>div{height:100%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2))}

  table{width:100%;border-collapse:collapse;font-size:.95rem}
  th,td{padding:.6rem .5rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  th{font-weight:600;color:#dde3ff}
  td.num{text-align:right}
  .empty{opacity:.65;font-style:italic}

  /* clickable pilot links */
  a.pilot{display:flex;align-items:center;gap:.6rem;color:inherit;text-decoration:none}
  a.pilot:hover span{text-decoration:underline}
  a.pilot:hover img{filter:brightness(1.08)}
  .pilot img{
    width:26px;height:26px;border-radius:50%;
    border:1px solid rgba(255,255,255,.18);
    background:#0b0b0b;object-fit:cover
  }
  .rank{width:2.3rem}

  /* MEDALS â€” gentle shine only (slow pulse) */
  .medal{display:inline-block;font-size:1.1rem;vertical-align:-2px;animation:pulse 6s ease-in-out infinite}
  .medal.g1{color:#ffd54a;text-shadow:0 0 6px rgba(255,215,64,.55),0 0 12px rgba(255,215,64,.35)}
  .medal.g2{color:#e2e8f0;text-shadow:0 0 6px rgba(200,210,230,.55),0 0 12px rgba(200,210,230,.35)}
  .medal.g3{color:#ffb47a;text-shadow:0 0 6px rgba(255,180,122,.55),0 0 12px rgba(255,180,122,.35)}
  @keyframes pulse{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-1px) scale(1.03)}}

  /* subtle emphasis on top 3 rows, no flashing */
  tbody tr.top1{box-shadow:inset 0 0 0 1px rgba(255,215,64,.22)}
  tbody tr.top2{box-shadow:inset 0 0 0 1px rgba(200,210,230,.18)}
  tbody tr.top3{box-shadow:inset 0 0 0 1px rgba(255,170,100,.18)}
</style>

</head>
<body>
<div class="stars"></div>

<header>
  <div class="wrap row">
    <h1 id="title" style="margin:0;font-size:1.25rem">TEST Alliance â€“ Deployment Tracker</h1>
    <span class="chip">Alliance: <code id="aid">?</code></span>
    <span class="chip">Region: <code id="rid">?</code> <span id="rname" class="muted"></span></span>
    <span class="chip">Window: <code id="win">from â†’ now</code></span>
    <span class="chip">Updated: <code id="upd">â€“</code></span>
    <span class="chip" id="policy"></span>
    <span id="status" class="muted right">idle</span>
  </div>
  <div class="wrap row" style="padding-bottom:.5rem">
    <button id="load">Load snapshot</button>
  </div>
</header>

<main class="wrap">
  <section class="grid" style="margin-bottom:1rem">
    <div class="card">
      <strong style="letter-spacing:.2px">Overview</strong>
      <div style="height:.35rem"></div>
      <div class="row" style="justify-content:space-between"><span class="muted">ISK killed</span><span id="isk">â€“</span></div>
      <div class="row" style="justify-content:space-between"><span class="muted">Ships killed</span><span id="ships">â€“</span></div>
      <div class="bar" style="margin-top:.5rem"><div id="goalbar" style="width:0%"></div></div>
      <div class="row" style="justify-content:space-between;margin-top:.35rem">
        <span class="muted">Goal</span><span><span id="goalpct">0%</span> (<span id="goal">â€“</span>)</span>
      </div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <strong>Top 10 â€” Solo kills</strong>
      <div style="max-height:520px;overflow:auto;margin-top:.4rem">
        <table id="solo">
          <thead><tr><th class="rank">#</th><th>Pilot</th><th class="num">Solo</th></tr></thead>
          <tbody><tr><td colspan="3" class="empty">no data</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <strong>Top 10 â€” ISK destroyed</strong>
      <div style="max-height:520px;overflow:auto;margin-top:.4rem">
        <table id="iskTable">
          <thead><tr><th class="rank">#</th><th>Pilot</th><th class="num">ISK</th></tr></thead>
          <tbody><tr><td colspan="3" class="empty">no data</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script type="module">
const $ = s => document.querySelector(s);
const fmtISK = n => new Intl.NumberFormat(undefined,{maximumFractionDigits:0}).format(Math.round(n||0))+' ISK';
const fmtNum = n => new Intl.NumberFormat().format(Math.round(n||0));

const els = {
  title:$('#title'), aid:$('#aid'), rid:$('#rid'), rname:$('#rname'), win:$('#win'),
  upd:$('#upd'), policy:$('#policy'), status:$('#status'),
  isk:$('#isk'), ships:$('#ships'), goal:$('#goal'), goalpct:$('#goalpct'), goalbar:$('#goalbar'),
  soloBody:document.querySelector('#solo tbody'), iskBody:document.querySelector('#iskTable tbody')
};

let CFG = {
  title:'TEST Alliance â€“ Deployment Tracker',
  allianceID:498125261,
  goalISK:500_000_000_000,
  regionID:10000014,
  regionName:'Catch',
  from:'2025-09-12',
  credit:'all',
  totalMetric:'destroyedValue'
};

async function loadCfg(){
  try{
    // Prefer GH Pages path; fall back to root for local dev
    let res = await fetch('./docs/site.json?ts='+Date.now(),{cache:'no-store'});
    if(!res.ok) res = await fetch('./site.json?ts='+Date.now(),{cache:'no-store'});
    const j = await res.json();
    CFG = {...CFG, ...(j||{})};
  }catch{}
  document.title = CFG.title || document.title;
  els.title.textContent = CFG.title || els.title.textContent;
  els.aid.textContent = CFG.allianceID;
  els.rid.textContent = CFG.regionID;
  els.rname.textContent = CFG.regionName ? `(${CFG.regionName})` : '';
  els.win.textContent = `${CFG.from} â†’ now`;
  els.goal.textContent = fmtISK(CFG.goalISK||0);
  els.policy.textContent = `metric: ${CFG.totalMetric||'destroyedValue'} Â· credit: ${CFG.credit||'all'}`;
}

function avatarUrl(id){
  const n = Number(id);
  return (n && isFinite(n)) ? `https://images.evetech.net/characters/${n}/portrait?size=64` : '';
}

/* CLICKABLE pilot cell to zKill */
function pilotCell(id, name){
  const src  = avatarUrl(id);
  const img  = src ? `<img src="${src}" alt="" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'">` : '';
  const href = `https://zkillboard.com/character/${Number(id)}/`;
  return `<a class="pilot" href="${href}" target="_blank" rel="noopener noreferrer">${img}<span>${name}</span></a>`;
}

function medal(i){
  if(i===0) return '<span class="medal g1">ðŸ¥‡</span>';
  if(i===1) return '<span class="medal g2">ðŸ¥ˆ</span>';
  if(i===2) return '<span class="medal g3">ðŸ¥‰</span>';
  return '';
}

function renderTop(tbody, entries, getVal){
  const rows = (entries||[]).slice(0,10).map((r,i)=>{
    const topClass = i<3 ? ` class="top${i+1}"` : '';
    return `<tr${topClass}>
      <td class="rank">${i+1} ${medal(i)}</td>
      <td>${pilotCell(r.id, r.name || r.n || r.id)}</td>
      <td class="num">${getVal(r)}</td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows || `<tr><td colspan="3" class="empty">no data</td></tr>`;
}

async function loadSnapshot(){
  els.status.textContent = 'loadingâ€¦';
  try{
    const res = await fetch('./data/summary.json?ts='+Date.now(),{cache:'no-store'});
    const s = await res.json();

    els.upd.textContent = s.generatedAt ? new Date(s.generatedAt).toLocaleString() : 'â€“';
    if (s.since) els.win.textContent = `${s.since} â†’ now`;

    els.isk.textContent   = fmtISK(s.totals?.isk || 0);
    els.ships.textContent = fmtNum(s.totals?.ships || 0);
    const pct = Math.max(0, Math.min(100, (s.totals?.isk||0)/(CFG.goalISK||1)*100));
    els.goalpct.textContent = pct.toFixed(1)+'%';
    els.goalbar.style.width = pct+'%';

    const names = s.names || {};
    const topISK  = (s.topISK || []).map(x => ({ id:x.id, isk:x.isk,   name:names[x.id] || x.name || String(x.id)}));
    const topSolo = (s.topSolo|| []).map(x => ({ id:x.id, count:x.count,name:names[x.id] || x.name || String(x.id)}));

    renderTop(els.iskBody,  topISK,  r => fmtISK(r.isk||0));
    renderTop(els.soloBody, topSolo, r => fmtNum(r.count||0));

    // admin chip (if you visit with ?admin=1)
    if (new URL(location.href).searchParams.get('admin') === '1' && s.debug){
      const dbg = s.debug;
      const e = document.createElement('div');
      e.className = 'wrap row';
      e.innerHTML = `<span class="chip">zKB pages: ${dbg.pages ?? 0}</span>
                     <span class="chip">Rows: ${dbg.rowsSeen ?? 0}</span>
                     <span class="chip">Older: ${dbg.rowsOlder ?? 0}</span>
                     <span class="chip">No TEST: ${dbg.rowsNoTest ?? 0}</span>
                     <span class="chip">Filtered: ${dbg.rowsFiltered ?? 0}</span>
                     <span class="chip">Counted: ${dbg.rowsCounted ?? 0}</span>
                     <span class="chip">ESI calls: ${dbg.esiCalls ?? 0}</span>`;
      const dv = document.createElement('div'); dv.style.marginTop = '-.5rem';
      dv.appendChild(e);
      document.querySelector('main').prepend(dv);
    }

    els.status.textContent = 'done';
  }catch(e){
    console.error(e);
    els.status.textContent = 'snapshot error';
  }
}

document.getElementById('load').addEventListener('click', loadSnapshot);

// init
await loadCfg();
await loadSnapshot();
</script>
</body>
</html>






