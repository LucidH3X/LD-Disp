<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TEST Alliance – Deployment Tracker</title>
<meta name="color-scheme" content="dark light"/>
<style>
  :root{--w:1100px;--pad:1rem}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,sans-serif;background:#0b0f1a;color:#e7ebff}
  header{position:sticky;top:0;background:linear-gradient(180deg,#0b0f1a,rgba(11,15,26,.6));backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
  .wrap{max-width:var(--w);margin:0 auto;padding:.75rem var(--pad)}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .muted{opacity:.75;font-size:.92rem}
  .chip{padding:.15rem .5rem;border:1px solid rgba(255,255,255,.16);border-radius:999px;background:rgba(255,255,255,.06);font-size:.85rem}
  button{font:inherit;padding:.5rem .8rem;border-radius:.6rem;border:1px solid rgba(255,255,255,.18);background:#111826;color:#e7ebff;cursor:pointer}
  main{padding:1rem 0 3rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
  .card{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:1rem;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02))}
  table{width:100%;border-collapse:collapse;font-size:.95rem}
  th,td{padding:.55rem .4rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  .right{text-align:right}
  .bar{height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.05)}
  .bar>div{height:100%;border-radius:999px;background:#8ab4ff}
  .empty{opacity:.6;font-style:italic}
  /* tiny starfield */
  .stars{position:fixed;inset:0;pointer-events:none;z-index:-1;background:radial-gradient(ellipse at center, #0b0f1a 0%, #060910 60%, #05070c 100%)}
  .stars:before,.stars:after{content:"";position:absolute;inset:0;background:transparent url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><circle cx="2" cy="2" r="1" fill="white" opacity=".8"/></svg>') repeat;opacity:.25;animation:tw 6s linear infinite}
  .stars:after{transform:scale(1.2);opacity:.18;animation-duration:9s}
  @keyframes tw{0%{opacity:.2}50%{opacity:.35}100%{opacity:.2}}
</style>
</head>
<body>
<div class="stars"></div>

<header>
  <div class="wrap row">
    <h1 id="title" style="margin:0;font-size:1.4rem">TEST Alliance – Deployment Tracker</h1>
    <span class="chip muted">Alliance: <code id="aid">?</code></span>
    <span class="chip muted">Region: <code id="rid">?</code> <span id="rname" class="muted"></span></span>
    <span class="chip muted">Window: <code id="win">from → now</code></span>
    <span class="chip muted">Updated: <code id="upd">–</code></span>
    <span class="chip muted" id="policy"></span>
    <span id="status" class="muted" style="margin-left:auto">idle</span>
  </div>
  <div class="wrap row" style="padding-bottom:.5rem">
    <button id="load">Load snapshot</button>
  </div>
</header>

<main class="wrap">
  <section class="grid" style="margin-bottom:1rem">
    <div class="card">
      <strong>Overview</strong>
      <div style="height:.5rem"></div>
      <div class="row" style="justify-content:space-between">
        <div class="muted">ISK killed</div><div id="isk">–</div>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="muted">Ships killed</div><div id="ships">–</div>
      </div>
      <div class="bar" style="margin-top:.4rem"><div id="goalbar" style="width:0%"></div></div>
      <div class="row" style="justify-content:space-between;margin-top:.35rem">
        <div class="muted">Goal</div><div><span id="goalpct">0%</span> (<span id="goal">–</span>)</div>
      </div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <strong>Top 10 — Solo kills</strong>
      <div style="max-height:520px;overflow:auto;margin-top:.4rem">
        <table id="solo">
          <thead><tr><th>#</th><th>Pilot</th><th class="right">Solo</th></tr></thead>
          <tbody><tr><td colspan="3" class="empty">no data</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <strong>Top 10 — ISK destroyed</strong>
      <div style="max-height:520px;overflow:auto;margin-top:.4rem">
        <table id="iskTable">
          <thead><tr><th>#</th><th>Pilot</th><th class="right">ISK</th></tr></thead>
          <tbody><tr><td colspan="3" class="empty">no data</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script type="module">
const $ = sel => document.querySelector(sel);
const fmtISK = n => new Intl.NumberFormat(undefined,{maximumFractionDigits:0}).format(Math.round(n))+" ISK";
const fmtNum = n => new Intl.NumberFormat().format(Math.round(n||0));

const els = {
  title: $('#title'), aid: $('#aid'), rid: $('#rid'), rname: $('#rname'), win: $('#win'),
  upd: $('#upd'), policy: $('#policy'), status: $('#status'),
  isk: $('#isk'), ships: $('#ships'), goal: $('#goal'), goalpct: $('#goalpct'), goalbar: $('#goalbar'),
  soloBody: document.querySelector('#solo tbody'),
  iskBody: document.querySelector('#iskTable tbody')
};

let CFG = {
  title: 'TEST Alliance – Deployment Tracker',
  allianceID: 498125261,
  goalISK: 500_000_000_000,
  regionID: 10000014,
  regionName: 'Catch',
  from: '2025-09-12'
};

async function loadCfg(){
  try{
    const j = await (await fetch('./docs/site.json?ts='+Date.now(), {cache:'no-store'})).json();
    CFG = {...CFG, ...(j||{})};
  }catch{}
  document.title = CFG.title || document.title;
  els.title.textContent = CFG.title || els.title.textContent;
  els.aid.textContent = CFG.allianceID;
  els.rid.textContent = CFG.regionID;
  els.rname.textContent = CFG.regionName ? `(${CFG.regionName})` : '';
  els.win.textContent = `${CFG.from} → now`;
  els.goal.textContent = fmtISK(CFG.goalISK||0);
  els.policy.textContent = `metric: ${CFG.totalMetric||'destroyedValue'} · credit: ${CFG.credit||'all'}`;
}

function renderTop(tbody, arr, fmt){
  const rows = (arr||[]).slice(0,10).map((r,i)=>{
    const name = r.name || r.n || r.id;
    const val  = fmt(r.isk ?? r.count ?? 0);
    return `<tr><td>${i+1}</td><td>${name}</td><td class="right">${val}</td></tr>`;
  }).join('');
  tbody.innerHTML = rows || `<tr><td colspan="3" class="empty">no data</td></tr>`;
}

async function loadSnapshot(){
  els.status.textContent = 'loading…';
  try{
    const res = await fetch('./data/summary.json?ts='+Date.now(), {cache:'no-store'});
    const s = await res.json();

    // header chips
    els.upd.textContent = s.generatedAt ? new Date(s.generatedAt).toLocaleString() : '–';
    if (s.since) els.win.textContent = `${s.since} → now`;

    // overview
    els.isk.textContent = fmtISK(s.totals?.isk || 0);
    els.ships.textContent = fmtNum(s.totals?.ships || 0);
    const pct = Math.max(0, Math.min(100, (s.totals?.isk || 0) / (CFG.goalISK||1) * 100));
    els.goalpct.textContent = pct.toFixed(1)+'%';
    els.goalbar.style.width = pct+'%';

    // map names
    const names = s.names || {};
    const topISK = (s.topISK||[]).map(x=>({id:x.id, isk:x.isk, name: names[x.id] || x.name || String(x.id)}));
    const topSolo= (s.topSolo||[]).map(x=>({id:x.id, count:x.count, name: names[x.id] || x.name || String(x.id)}));

    renderTop(els.iskBody,  topISK, v => fmtISK(v));
    renderTop(els.soloBody, topSolo, v => fmtNum(v));

    els.status.textContent = 'done';
  }catch(e){
    console.error(e);
    els.status.textContent = 'snapshot error';
  }
}

$('#load').addEventListener('click', loadSnapshot);

// init
await loadCfg();
await loadSnapshot();
</script>
</body>
</html>


